name: Download, Unzip and Deploy Angular Build to Nginx

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      env:
        description: "Select environment (dev/prod/qa)"
        required: true
        default: "dev"
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Download latest release asset
      - name: Download latest release zip
        uses: robinraju/release-downloader@v1.11
        with:
          repository: ${{ github.repository }}
          latest: true
          fileName: angular-build.zip
          token: ${{ secrets.GITHUB_TOKEN }}

      # 3Ô∏è‚É£ Unzip the release
      - name: Unzip angular-build.zip
        run: |
          echo "üì¶ Unzipping angular-build.zip..."
          mkdir -p ./unzipped_build
          unzip -o angular-build.zip -d ./unzipped_build
          echo "‚úÖ Unzip complete. Contents:"
          ls -lR ./unzipped_build

      # 4Ô∏è‚É£ Inject environment config
      - name: Inject environment config
        run: |
          ENV=${{ github.event.inputs.env || 'dev' }}
          echo "üåç Selected environment: $ENV"

          CONFIG_SOURCE="./config/config.${ENV}.json"

          # Detect the actual assets folder inside the unzipped build
          if [ -d "./unzipped_build/assets" ]; then
            ASSETS_DIR="./unzipped_build/assets"
          elif [ -d "./unzipped_build/TestEnv/assets" ]; then
            ASSETS_DIR="./unzipped_build/TestEnv/assets"
          elif [ -d "./unzipped_build/browser/assets" ]; then
            ASSETS_DIR="./unzipped_build/browser/assets"
          else
            echo "‚ùå Assets folder not found in unzipped build!"
            exit 1
          fi

          CONFIG_TARGET="$ASSETS_DIR/config.json"

          if [ -f "$CONFIG_SOURCE" ]; then
            echo "‚úÖ Using config file: $CONFIG_SOURCE"
            cp "$CONFIG_SOURCE" "$CONFIG_TARGET"
          else
            echo "‚ö†Ô∏è Config file for $ENV not found. Using existing one."
          fi

      # 5Ô∏è‚É£ Deploy to Nginx
      - name: Deploy to /var/www/html
        run: |
          echo "üöÄ Deploying Angular build to /var/www/html..."
          sudo rm -rf /var/www/html/*
          
          # Detect if the unzipped build has a subfolder (TestEnv/browser) and copy correctly
          if [ -d "./unzipped_build/TestEnv" ]; then
            sudo cp -r ./unzipped_build/TestEnv/* /var/www/html/
          elif [ -d "./unzipped_build/browser" ]; then
            sudo cp -r ./unzipped_build/browser/* /var/www/html/
          else
            sudo cp -r ./unzipped_build/* /var/www/html/
          fi

          sudo chown -R www-data:www-data /var/www/html
          sudo chmod -R 755 /var/www/html

          echo "Deployment completed. List final /var/www/html:"
          sudo ls -l /var/www/html

      # 6Ô∏è‚É£ Verify index.html exists
      - name: Verify deployment
        run: |
          if [ -f /var/www/html/index.html ]; then
            echo "‚úÖ index.html found. Angular app deployed successfully!"
          else
            echo "‚ùå index.html missing. Deployment failed."
            echo "üìÇ Directory contents:"
            sudo ls -l /var/www/html
            exit 1
          fi

      # 7Ô∏è‚É£ Reload Nginx
      - name: Reload Nginx
        run: |
          echo "üîÑ Reloading Nginx..."
          sudo nginx -t
          sudo systemctl reload nginx
          echo "üöÄ Nginx reloaded successfully!"
