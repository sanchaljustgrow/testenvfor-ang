name: Deploy Angular Build to Local Nginx (Ubuntu)

on:
  workflow_dispatch:   # Manual trigger
  release:
    types: [published] # Trigger automatically on release publish

jobs:
  deploy:
    name: Deploy Angular Build
    runs-on: self-hosted

    steps:
      # 1ï¸âƒ£ Update and install dependencies
      - name: Install dependencies
        run: |
          sudo apt update -y
          sudo apt install -y unzip nginx

      # 2ï¸âƒ£ Download latest release asset
      - name: Download latest release asset
        if: github.event_name == 'release'
        uses: robinraju/release-downloader@v1.11
        with:
          repository: ${{ github.repository }}
          latest: true
          fileName: angular-build.zip
          token: ${{ secrets.GITHUB_TOKEN }}

      # 3ï¸âƒ£ Check for the build zip
      - name: Check if build zip exists
        run: |
          if [ ! -f angular-build.zip ]; then
            echo "âŒ No release zip found. Please upload angular-build.zip or trigger via release."
            exit 1
          fi

      # 4ï¸âƒ£ Unzip and deploy Angular build
      - name: Unzip and deploy
        run: |
          echo "ğŸ“¦ Unzipping angular-build.zip..."
          mkdir -p ./unzipped_build
          unzip -o angular-build.zip -d ./unzipped_build
          echo "ğŸ“‚ Files after unzip:"
          ls -lR ./unzipped_build

          # echo "ğŸš€ Deploying to /var/www/html/TestEnv..."
          # sudo mkdir -p /var/www/html/TestEnv
          # sudo cp -r ./unzipped_build/* /var/www/html/TestEnv/

    

      # 6ï¸âƒ£ Restart Nginx
      - name: Restart Nginx
        run: |
          echo "ğŸ”„ Restarting Nginx..."
          sudo systemctl restart nginx
          sudo systemctl status nginx --no-pager
