name: Deploy Angular build to Nginx


on:
  push:
    branches:
      - main
  workflow_dispatch:
  release:
    types: [published]

jobs:
  deploy:
    name: Deploy Angular build to Nginx
  s
    runs-on: self-hosted

    steps:
      # Step 1: Checkout repository code (needed for context and standard practice)
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Install dependencies (Nginx and Unzip)
      - name: Install dependencies
        run: |
          echo "Installing dependencies..."
          # Use DEBIAN_FRONTEND=noninteractive to prevent apt from hanging on interactive prompts
          sudo apt update -y
          sudo DEBIAN_FRONTEND=noninteractive apt install -y unzip nginx
          sudo systemctl enable nginx
          echo "Dependencies installed."

      # Step 3: Download latest release asset
    
      - name: Download latest release asset 
        if: github.event_name == 'release'
        uses: robinraju/release-downloader@v1.11
        with:
          repository: ${{ github.repository }}
          latest: true
          fileName: angular-build.zip
          token: ${{ secrets.GITHUB_TOKEN }}
      
      

      # Step 4: Unzip the build
     
      - name: Unzip build
        run: |
          if [ -f angular-build.zip ]; then
            echo "Unzipping angular-build.zip..."
            # Create a clean directory for extraction
            mkdir -p ./unzipped_build
            unzip -o angular-build.zip -d ./unzipped_build
            echo "Contents of unzipped_build directory:"
            ls -lR ./unzipped_build
          else
            echo "angular-build.zip not found. This step might be skipped if not triggered by a release."
            # If we are on a release trigger and it's missing, fail the workflow
            if [ "${{ github.event_name }}" == "release" ]; then
              exit 1
            fi
          fi

      # Step 5: Deploy the extracted 'browser' folder to Nginx directory
      - name: Deploy to Nginx
        run: |
          echo "Deploying build to /var/www/html/TestEnv..."
          DEPLOY_PATH="/var/www/html/TestEnv"
          # This path assumes your zip structure is 'angular-build.zip -> TestEnv/browser/*'
          SOURCE_PATH="./unzipped_build/TestEnv/browser/" 
          
          if [ -d "$SOURCE_PATH" ]; then
            sudo mkdir -p "$DEPLOY_PATH"
            # Clear previous deployment files safely
            sudo rm -rf "$DEPLOY_PATH"/*
            # Copy all files from source to destination
            sudo cp -r "$SOURCE_PATH"* "$DEPLOY_PATH"/
            
            # Set correct ownership for Nginx user (www-data is standard on Ubuntu)
            sudo chown -R www-data:www-data "$DEPLOY_PATH"
            # Set correct permissions
            sudo chmod -R 755 "$DEPLOY_PATH"
            echo "Deployment complete."
          else
            echo "Source directory $SOURCE_PATH not found. Skipping deployment."
            # If we successfully unzipped but the path is wrong, fail the workflow
            if [ -d "./unzipped_build" ]; then
                exit 1
            fi
          fi

      # Step 6: Restart Nginx to ensure it picks up changes
      - name: Restart Nginx
        run: |
          echo "Restarting Nginx..."
          sudo systemctl restart nginx
         
          sudo systemctl status nginx
