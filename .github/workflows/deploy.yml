name: Deploy Angular Build to Local Nginx (Ubuntu)

on:
  push: 
    branches:
      - main              # Trigger on push to main
  workflow_dispatch:       # Allow manual trigger from Actions tab
  release:
    types: [published]     # Trigger automatically on new GitHub release

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download latest release asset
        uses: dsaltares/fetch-gh-release-asset@v1
        with:
          repo: ${{ github.repository }}
          file: build1.zip            # âš ï¸ Make sure this matches your actual release asset name
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract and Deploy
        run: |
          echo "ğŸš€ Starting deployment..."
          DEPLOY_DIR=~/testenv-deploy
          mkdir -p $DEPLOY_DIR
          rm -rf $DEPLOY_DIR/*

          echo "ğŸ“¦ Moving and extracting build..."
          mv build1.zip $DEPLOY_DIR/
          cd $DEPLOY_DIR
          unzip -o build1.zip
          rm build1.zip

          echo "âœ… Build extracted successfully at $DEPLOY_DIR"

      - name: Install & Configure Nginx
        run: |
          echo "ğŸŒ Setting up Nginx..."
          sudo apt update -y
          sudo apt install -y nginx unzip

          echo "ğŸ§¹ Cleaning existing Nginx html folder..."
          sudo rm -rf /var/www/html/*

          echo "ğŸ“ Copying new build files to Nginx directory..."
          sudo cp -r ~/testenv-deploy/* /var/www/html/

          echo "ğŸ”„ Restarting Nginx..."
          sudo systemctl restart nginx
          sudo systemctl enable nginx

          echo "âœ… Deployment complete!"
          echo "ğŸŒ Visit: http://localhost or http://$(hostname -I | awk '{print $1}')"
