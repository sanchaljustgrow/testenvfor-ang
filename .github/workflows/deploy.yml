name: Deploy Angular App to Nginx

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      env:
        description: "Select environment (dev/prod/qa)"
        required: true
        default: "dev"
  push:
    branches:
      - main  # Only trigger on main branch

jobs:
  deploy:
    runs-on: self-hosted
    name: Deploy Angular Build to Nginx

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Download latest release asset
      - name: Download latest release zip
        uses: robinraju/release-downloader@v1.11
        with:
          repository: ${{ github.repository }}
          latest: true
          fileName: angular-build.zip
          token: ${{ secrets.GITHUB_TOKEN }}

      # 3Ô∏è‚É£ Unzip the release build
      - name: Extract release zip
        run: |
          echo "üì¶ Extracting release..."
          mkdir -p /tmp/build
          unzip -o angular-build.zip -d /tmp/build/
          ls -l /tmp/build

      # 4Ô∏è‚É£ Inject environment config
      - name: Inject environment config
        run: |
          ENV=${{ github.event.inputs.env || 'dev' }}
          echo "üåç Selected environment: $ENV"

          CONFIG_SOURCE="./config/config.${ENV}.json"
          CONFIG_TARGET="/tmp/build/TestEnv/browser/assets/config.json"

          # Ensure target folder exists
          mkdir -p "$(dirname "$CONFIG_TARGET")"

          if [ -f "$CONFIG_SOURCE" ]; then
            echo "‚úÖ Using config file: $CONFIG_SOURCE"
            cp "$CONFIG_SOURCE" "$CONFIG_TARGET"
          else
            echo "‚ö†Ô∏è Config file for $ENV not found. Using existing one."
          fi

      # 5Ô∏è‚É£ Deploy to Nginx
      - name: Deploy to Nginx
        run: |
          ENV=${{ github.event.inputs.env || 'dev' }}
          DEPLOY_DIR="/var/www/${ENV}"

          echo "üìÇ Deploying to $DEPLOY_DIR"
          sudo mkdir -p $DEPLOY_DIR
          sudo rm -rf ${DEPLOY_DIR:?}/*
          sudo cp -r /tmp/build/TestEnv/* $DEPLOY_DIR/
          sudo chown -R www-data:www-data $DEPLOY_DIR
          sudo chmod -R 755 $DEPLOY_DIR

      # 6Ô∏è‚É£ Verify deployment success
      - name: Verify Deployment
        run: |
          ENV=${{ github.event.inputs.env || 'dev' }}
          DEPLOY_DIR="/var/www/${ENV}"

          if [ -f "${DEPLOY_DIR}/browser/index.html" ]; then
            echo "‚úÖ index.html found. Angular app deployed successfully!"
          else
            echo "‚ùå index.html missing. Deployment failed."
            echo "üìÇ Directory contents:"
            sudo ls -l ${DEPLOY_DIR}
            exit 1
          fi

      # 7Ô∏è‚É£ Reload Nginx
      - name: Reload Nginx
        run: |
          sudo nginx -t && sudo systemctl reload nginx
          echo "üöÄ Nginx reloaded successfully!"
