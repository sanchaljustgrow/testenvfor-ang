name: Deploy Angular Build to Local Nginx (Ubuntu)

on:
  push:
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy Angular Build
    runs-on: self-hosted

    steps:
      #  Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      #  Install unzip & Nginx if not present
      - name: Ensure unzip and nginx installed
        run: |
          sudo apt update -y
          sudo apt install -y unzip nginx

      #  Download the latest release asset (zip)
      - name: Download latest release asset (Release Trigger Only)
        if: github.event_name == 'release'
        uses: robinraju/release-downloader@v1.11
        with:
          repository: ${{ github.repository }}
          latest: true
          fileName: angular-build.zip
          token: ${{ secrets.GITHUB_TOKEN }}

      #  If manually triggered or push, ensure angular-build.zip exists
      - name: Check if build zip exists
        run: |
          if [ ! -f angular-build.zip ]; then
            echo "No release zip found. Please upload angular-build.zip or trigger via release."
            exit 1
          fi

      #  Unzip build
      - name: Unzip Angular build
        run: |
          sudo rm -rf /var/www/html/TestEnv
          sudo mkdir -p /var/www/html/TestEnv
          sudo unzip -o angular-build.zip -d /var/www/html/TestEnv
          sudo chown -R www-data:www-data /var/www/html/TestEnv
          sudo chmod -R 755 /var/www/html/TestEnv

      #  Configure Nginx for Angular app
      - name: Configure Nginx to serve Angular app
        run: |
          echo "Configuring Nginx to serve Angular app..."
          NGINX_CONF="/etc/nginx/sites-enabled/default"
          sudo bash -c "cat > $NGINX_CONF" <<'EOF'
          server {
              listen 80 default_server;
              listen [::]:80 default_server;

              server_name _;

              root /var/www/html/TestEnv;
              index index.html;

              location / {
                  try_files $uri $uri/ /index.html;
              }
          }
          EOF

          sudo nginx -t
          sudo systemctl restart nginx

      #  Verify deployment
      - name: Verify Deployment
        run: |
          curl -I http://localhost || true
