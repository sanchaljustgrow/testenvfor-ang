name: Deploy Angular Build to Nginx

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger
  release:
    types: [published]  # Also trigger on release publish

jobs:
  deploy:
    name: Deploy Angular App to Nginx
    runs-on: self-hosted  # or ubuntu-latest if you use SSH deployment

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Download the latest release artifact (build.zip)
      - name: Download latest release ZIP
        run: |
          mkdir -p /tmp/deploy
          echo "Downloading release asset..."
          curl -L -o /tmp/deploy/build.zip $(curl -s https://api.github.com/repos/${{ github.repository }}/releases/latest | grep browser_download_url | cut -d '"' -f 4)
          echo "‚úÖ Download completed."

      # 3Ô∏è‚É£ Unzip the build into a temp directory
      - name: Extract build
        run: |
          cd /tmp/deploy
          unzip -o build.zip -d build
          echo "‚úÖ Build extracted:"
          ls -l build

      # 4Ô∏è‚É£ Deploy to Nginx root directory
      - name: Deploy to Nginx
        run: |
          sudo mkdir -p /var/www/html
          sudo rm -rf /var/www/html/*
          sudo cp -r /tmp/deploy/build/* /var/www/html/
          echo "‚úÖ Files deployed to /var/www/html"

      # 5Ô∏è‚É£ Verify that index.html exists
      - name: Verify deployment
        run: |
          if [ -f /var/www/html/index.html ]; then
            echo "‚úÖ index.html found. Angular app deployed successfully!"
          else
            echo "‚ùå index.html missing. Deployment failed."
            echo "Directory contents:"
            ls -l /var/www/html
            exit 1
          fi

      # 6Ô∏è‚É£ Test Nginx configuration
      - name: Test Nginx config
        run: |
          sudo nginx -t

      # 7Ô∏è‚É£ Reload Nginx to apply changes
      - name: Reload Nginx
        run: |
          sudo systemctl reload nginx
          echo "‚úÖ Nginx reloaded successfully!"

      # 8Ô∏è‚É£ Optional: Show deployment summary
      - name: Deployment Summary
        run: |
          echo "-------------------------------------"
          echo "üåê Angular app deployed successfully!"
          echo "üìÅ Path: /var/www/html"
          echo "-------------------------------------"
