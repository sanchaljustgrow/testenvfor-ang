name: Deploy Angular build to Nginx

on:
  push:
    branches:
      - main
  workflow_dispatch:
  release:
    types: [published]

jobs:
  deploy:
    name: Deploy Angular build to Nginx
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt update -y
          sudo DEBIAN_FRONTEND=noninteractive apt install -y unzip nginx
          sudo systemctl enable nginx

      - name: Download latest release asset (Release Trigger Only)
        if: github.event_name == 'release'
        uses: robinraju/release-downloader@v1.11
        with:
          repository: ${{ github.repository }}
          latest: true
          fileName: angular-build.zip
          token: ${{ secrets.GITHUB_TOKEN }}
    

      # Unzip the build
      - name: Unzip build
        run: |
          if [ -f angular-build.zip ]; then
            echo "Unzipping angular-build.zip..."
            mkdir -p ./unzipped_build
            unzip -o angular-build.zip -d ./unzipped_build
            ls -lR ./unzipped_build
          else
            echo "angular-build.zip not found. Skipping unzip step (expected if not a Release event)."
            # Only exit 1 (fail the job) if the trigger *was* a release event
            if [ "${{ github.event_name }}" == "release" ]; then exit 1; fi
          fi

   
      - name: Deploy to Nginx
        run: |
          echo "Deploying build to /var/www/html/TestEnv..."
          DEPLOY_PATH="/var/www/html/TestEnv"
          # NOTE: The path below assumes your zip file contains a TestEnv/browser folder structure
          SOURCE_PATH="./unzipped_build/TestEnv/browser/" 
          
          if [ -d "$SOURCE_PATH" ]; then
            sudo mkdir -p "$DEPLOY_PATH"
            sudo rm -rf "$DEPLOY_PATH"/*
            sudo cp -r "$SOURCE_PATH"* "$DEPLOY_PATH"/
            
            sudo chown -R www-data:www-data "$DEPLOY_PATH"
            sudo chmod -R 755 "$DEPLOY_PATH"
            echo "Deployment complete."
          else
            echo "Source directory $SOURCE_PATH not found. Skipping deployment."
            # Only exit 1 if the source path was expected
             if [ -f angular-build.zip ]; then exit 1; fi
          fi

      # Restart Nginx
      - name: Restart Nginx
        run: |
          echo "Restarting Nginx..."
          sudo systemctl restart nginx
          sudo systemctl status nginx
