name: Download, Unzip and Deploy Angular Build to Nginx

# Trigger manually or on release/push
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      env:
        description: "Deployment environment"
        required: true
        default: "dev"
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Download latest release asset
      - name: Download latest release zip
        uses: robinraju/release-downloader@v1.11
        with:
          repository: ${{ github.repository }}
          latest: true
          fileName: angular-build.zip
          token: ${{ secrets.GITHUB_TOKEN }}

      # 3️⃣ Unzip the release
      - name: Unzip angular-build.zip
        run: |
          mkdir -p ./unzipped_build
          unzip -o angular-build.zip -d ./unzipped_build
          echo "Unzip complete. Contents:"
          ls -lR ./unzipped_build

      # 4️⃣ Inject environment config
      - name: Inject environment config
        run: |
          ENV=${{ github.event.inputs.env || 'dev' }}
          echo "Selected environment: $ENV"

          CONFIG_SOURCE="./config/config.${ENV}.json"

          ASSETS_DIR=$(find ./unzipped_build -type d -name "assets" | head -n1)
          if [ -z "$ASSETS_DIR" ]; then
            echo "Assets folder not found!"
            exit 1
          fi

          CONFIG_TARGET="$ASSETS_DIR/config.json"

          if [ -f "$CONFIG_SOURCE" ]; then
            cp "$CONFIG_SOURCE" "$CONFIG_TARGET"
            echo "Config file copied for $ENV"
          else
            echo "Config file for $ENV not found, using default"
          fi

      # 5️⃣ Deploy to Nginx root
      - name: Deploy to /var/www/html
        run: |
          sudo rm -rf /var/www/html/*
          BUILD_DIR=$(find ./unzipped_build -mindepth 1 -maxdepth 1 -type d | head -n1)
          if [ -z "$BUILD_DIR" ]; then BUILD_DIR="./unzipped_build"; fi
          sudo cp -r $BUILD_DIR/* /var/www/html/

          # Flatten common folders if present
          for folder in TestEnv browser; do
            if [ -d "/var/www/html/$folder" ]; then
              sudo mv /var/www/html/$folder/* /var/www/html/
              sudo rm -rf /var/www/html/$folder
            fi
          done

          sudo chown -R www-data:www-data /var/www/html
          sudo chmod -R 755 /var/www/html
          echo "Deployment completed."

      # 6️⃣ Verify deployment
      - name: Verify deployment
        run: |
          if [ -f /var/www/html/index.html ]; then
            echo "Angular app deployed successfully!"
          else
            echo "Deployment failed, index.html not found."
            exit 1
          fi

      # 7️⃣ Reload Nginx
      - name: Reload Nginx
        run: |
          sudo nginx -t
          sudo systemctl reload nginx
          echo "Nginx reloaded successfully!"
