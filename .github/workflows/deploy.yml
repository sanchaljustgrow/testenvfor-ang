name: Deploy Angular App to Nginx

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Select environment (dev/prod/qa)"
        required: true
        default: "dev"


jobs:
  deploy:
    runs-on: self-hosted
    name: Deploy Angular Build to Nginx

    steps:
      # 1Ô∏è‚É£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download release artifact
        with:
          name: release-zip
          path: ./artifact

      # 3Ô∏è‚É£ Unzip the release build
      - name: Extract release zip
        run: |
          echo "üì¶ Extracting release..."
          mkdir -p /tmp/build
          unzip -o angular-build.zip -d /tmp/build/
          ls -l /tmp/build

      # 4Ô∏è‚É£ Inject environment config
      - name: Inject environment config
        run: |
          ENV=${{ github.event.inputs.env || 'dev' }}
          echo "üåç Selected environment: $ENV"

          CONFIG_SOURCE="./config/config.${ENV}.json"
          CONFIG_TARGET="/tmp/build/assets/config.json"

          if [ -f "$CONFIG_SOURCE" ]; then
            echo "‚úÖ Using config file: $CONFIG_SOURCE"
            cp "$CONFIG_SOURCE" "$CONFIG_TARGET"
          else
            echo "‚ö†Ô∏è Config file for $ENV not found. Using existing one."
          fi


          DEPLOY_DIR="/var/www/${ENV}"

          echo "üìÇ Deploying to $DEPLOY_DIR"
          sudo mkdir -p $DEPLOY_DIR
          sudo rm -rf ${DEPLOY_DIR:?}/*
          sudo cp -r /tmp/build/* $DEPLOY_DIR/
          sudo chown -R www-data:www-data $DEPLOY_DIR
          sudo chmod -R 755 $DEPLOY_DIR

      # 6Ô∏è‚É£ Verify deployment success
      - name: Verify Deployment
        run: |

          DEPLOY_DIR="/var/www/${ENV}"

          if [ -f "${DEPLOY_DIR}/index.html" ]; then
            echo "‚úÖ index.html found. Angular app deployed successfully!"
          else
            echo "‚ùå index.html missing. Deployment failed."
            echo "üìÇ Directory contents:"
            sudo ls -l ${DEPLOY_DIR}
            exit 1
          fi


      - name: Reload Nginx
        run: |
          sudo nginx -t && sudo systemctl reload nginx
          echo "üöÄ Nginx reloaded successfully!"
