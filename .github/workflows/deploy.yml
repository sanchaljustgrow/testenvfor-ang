name: Deploy Angular Build to Local Nginx (Ubuntu)

on:
  push:
    branches:
      - main
  workflow_dispatch:
  release:
    types: [published]

jobs:
  deploy:
    name: Deploy Angular build to Nginx
    runs-on: self-hosted

    steps:
      # 1ï¸âƒ£ Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Install dependencies (unzip + nginx)
      - name: Install dependencies
        run: |
          echo "Installing dependencies..."
          sudo apt update -y
          sudo apt install -y unzip nginx
          sudo systemctl enable nginx
          echo "âœ… Dependencies installed."

      # 3ï¸âƒ£ Download latest release asset
      - name: Download latest release asset
        uses: robinraju/release-downloader@v1.11
        with:
          repository: ${{ github.repository }}
          latest: true
          fileName: angular-build.zip
          token: ${{ secrets.GITHUB_TOKEN }}

      # 4ï¸âƒ£ Unzip the build
      - name: Unzip build
        run: |
          echo "ðŸ“¦ Unzipping angular-build.zip..."
          unzip -o angular-build.zip -d ./angular-build
          ls -l ./angular-build

      # 5ï¸âƒ£ Deploy browser folder to Nginx
      - name: Deploy to Nginx
        run: |
          echo "Deploying build to /var/www/html/TestEnv..."
          sudo mkdir -p /var/www/html/TestEnv
          sudo rm -rf /var/www/html/TestEnv/*
          sudo cp -r ./angular-build/TestEnv/browser/* /var/www/html/TestEnv/
          sudo chown -R www-data:www-data /var/www/html/TestEnv
          sudo chmod -R 755 /var/www/html/TestEnv
          echo "âœ… Deployment complete."

      # 6ï¸âƒ£ Configure Nginx for Angular SPA (safe, idempotent)
      - name: Configure Nginx for SPA
        run: |
          echo "Configuring Nginx for Angular SPA..."
          NGINX_CONF="/etc/nginx/sites-available/default"
          # Remove existing TestEnv location block if exists
          sudo sed -i '/location \/TestEnv\//,/}/d' $NGINX_CONF
          # Add the correct block
          sudo bash -c "cat >> $NGINX_CONF <<EOF
location /TestEnv/ {
    root /var/www/html;
    index index.html;
    try_files \$uri /TestEnv/index.html;
}
EOF"
          sudo nginx -t
          echo "âœ… Nginx configured."

      # 7ï¸âƒ£ Restart Nginx
      - name: Restart Nginx
        run: |
          echo "Restarting Nginx..."
          sudo systemctl restart nginx
          sudo systemctl status nginx --no-pager
