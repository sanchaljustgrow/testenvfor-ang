name: Deploy Angular Release to Nginx

on:
 
  release:
    types: [published]  # Trigger when a release is published

jobs:
  deploy:
    runs-on: self-hosted
    name: Deploy Angular Build

    steps:
      # 1️⃣ Install dependencies
      - name: Install dependencies
        run: |
          sudo apt update -y
          sudo apt install -y unzip nginx jq
          sudo systemctl enable nginx

      # 2️⃣ Get download URL of angular-build.zip from release
      - name: Get release asset URL
        id: get_asset
        run: |
          ASSET_NAME="angular-build.zip"
          REPO="${{ github.repository }}"
          TAG="${{ github.event.release.tag_name }}"
          API_URL="https://api.github.com/repos/$REPO/releases/tags/$TAG"

          ASSET_URL=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" $API_URL \
            | jq -r ".assets[] | select(.name==\"$ASSET_NAME\") | .url")

          if [ -z "$ASSET_URL" ]; then
            echo "Error: Asset not found"
            exit 1
          fi

          echo "ASSET_URL=$ASSET_URL" >> $GITHUB_ENV

      # 3️⃣ Download the asset
      - name: Download angular-build.zip
        run: |
          curl -L -H "Accept: application/octet-stream" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            $ASSET_URL -o angular-build.zip
