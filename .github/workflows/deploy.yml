name: Deploy Angular Build to Local Nginx (Ubuntu)

on:
  push:
    branches:
      - main            # ‚úÖ Correct syntax for branch trigger
  workflow_dispatch:     # Allows manual trigger from the Actions tab
  release:
    types: [published]   # Triggers automatically when a new release is published

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download latest release asset
        uses: dsaltares/fetch-gh-release-asset@v1
        with:
          repo: ${{ github.repository }}
          file: build1.zip          # ‚ö†Ô∏è Update this if your release asset name is different
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract and Deploy
        run: |
          echo "üöÄ Starting deployment..."
          DEPLOY_DIR=~/testenv-deploy
          mkdir -p $DEPLOY_DIR
          rm -rf $DEPLOY_DIR/*

          mv build1.zip $DEPLOY_DIR/
          cd $DEPLOY_DIR
          unzip -o build1.zip
          rm build1.zip

          echo "‚úÖ Build extracted successfully"

      - name: Install & Configure Nginx
        run: |
          echo "üåê Setting up Nginx..."
          sudo apt update -y
          sudo apt install -y nginx unzip

          # Clean existing Nginx html folder
          sudo rm -rf /var/www/html/*

          # Copy new build files
          sudo cp -r ~/testenv-deploy/* /var/www/html/

          # Restart Nginx service
          sudo systemctl restart nginx
          sudo systemctl enable nginx

          echo "‚úÖ Deployment complete! Visit: http://localhost or your machine IP"
