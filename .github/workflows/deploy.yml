name: Deploy Angular build to Nginx

on:
  push:
    branches:
      - main
  workflow_dispatch:
  release:
    types: [published]

jobs:
  deploy:
    name: Deploy Angular build to Nginx
    runs-on: self-hosted

    steps:
      # 1️⃣ Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Install Nginx and unzip if not installed
      - name: Install dependencies
        run: |
          sudo apt update -y
          sudo DEBIAN_FRONTEND=noninteractive apt install -y unzip nginx
          sudo systemctl enable nginx

      # 3️⃣ Always download latest release zip (even on manual or push)
      - name: Download latest release asset
        uses: robinraju/release-downloader@v1.11
        with:
          repository: ${{ github.repository }}
          latest: true
          fileName: angular-build.zip
          token: ${{ secrets.GITHUB_TOKEN }}

      # 4️⃣ Unzip the Angular build
      - name: Unzip build
        run: |
          if [ -f angular-build.zip ]; then
            echo "Unzipping angular-build.zip..."
            mkdir -p ./unzipped_build
            unzip -o angular-build.zip -d ./unzipped_build
            ls -lR ./unzipped_build
          else
            echo "angular-build.zip not found! Exiting..."
            exit 1
          fi

      # 5️⃣ Deploy build to Nginx path
      - name: Deploy to Nginx
        run: |
          echo "Deploying Angular build to /var/www/html/TestEnv..."
          DEPLOY_PATH="/var/www/html/TestEnv"
          SOURCE_PATH="./unzipped_build/TestEnv/browser/"

          if [ -d "$SOURCE_PATH" ]; then
            sudo mkdir -p "$DEPLOY_PATH"
            sudo rm -rf "$DEPLOY_PATH"/*
            sudo cp -r "$SOURCE_PATH"* "$DEPLOY_PATH"/
            sudo chown -R www-data:www-data "$DEPLOY_PATH"
            sudo chmod -R 755 "$DEPLOY_PATH"
            echo "✅ Deployment complete."
          else
            echo "❌ Source directory $SOURCE_PATH not found!"
            exit 1
          fi

      # 6️⃣ Configure Nginx for Angular SPA
      - name: Configure Nginx for Angular app
        run: |
          echo "Configuring Nginx to serve Angular app..."
          NGINX_CONF="/etc/nginx/sites-enabled/default"
          sudo bash -c "cat > $NGINX_CONF" <<'EOF'
server {
    listen 80 default_server;
    listen [::]:80 default_server;

    server_name _;

    root /var/www/html/TestEnv;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }

    error_page 404 /index.html;
}
EOF

          sudo nginx -t
          sudo systemctl reload nginx
          echo "✅ Nginx configuration updated successfully."

      # 7️⃣ Restart Nginx
      - name: Restart Nginx
        run: |
          echo "Restarting Nginx..."
          sudo systemctl restart nginx
          sudo systemctl status nginx --no-pager
