name: Deploy Angular Build to Nginx (Ubuntu)

on:
  push:
    branches:
      - main
  release:
    types: [published]
  workflow_dispatch:  
jobs:
  deploy:
    runs-on: self-hosted
    name: Download and Deploy Angular App

    steps:
      # Download latest release asset (ZIP)
      - name: Download latest Angular build
        uses: robinraju/release-downloader@v1.11
        with:
          repository: ${{ github.repository }}
          latest: true
          fileName: angular-build.zip
          token: ${{ secrets.GITHUB_TOKEN }}

      #  Unzip the build
      - name: Unzip angular-build.zip
        run: |
          echo " Unzipping Angular build..."
          mkdir -p ./unzipped_build
          unzip -o angular-build.zip -d ./unzipped_build
          echo " Unzip complete. Contents:"
          ls -l ./unzipped_build

      #  Move build to /var/www/html (Nginx directory)
      - name: Deploy to Nginx web root
        run: |
          echo " Deploying files to /var/www/html..."
          sudo rm -rf /var/www/html/*
          sudo cp -r ./unzipped_build/* /var/www/html/
          sudo chown -R www-data:www-data /var/www/html
          sudo chmod -R 755 /var/www/html
          echo " Deployment complete."

      #   Restart Nginx
      - name: Restart Nginx
        run: |
          echo " Restarting Nginx..."
          sudo systemctl restart nginx
          sudo systemctl status nginx --no-pager
          echo " Nginx restarted successfully."

      # Verify index.html exists
      - name: Verify Deployment
        run: |
          if [ -f /var/www/html/index.html ]; then
            echo " index.html found. Angular app deployed successfully!"
          else
            echo " index.html missing. Deployment failed."
            exit 1
          fi
