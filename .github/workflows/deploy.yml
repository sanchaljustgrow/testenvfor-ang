name: Download, Unzip and Deploy Angular Build to Nginx

on:
  release:
    types: [published] # Trigger when a new release is published
  workflow_dispatch:    # Allow manual trigger
  push:
    branches:
      - main            # Optional: auto-deploy on main branch

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # ğŸ§± 1ï¸âƒ£ Download latest release asset
      - name: Download latest release asset
        uses: robinraju/release-downloader@v1.11
        with:
          repository: ${{ github.repository }}
          latest: true
          fileName: angular-build.zip
          token: ${{ secrets.GITHUB_TOKEN }}

      # ğŸ“¦ 2ï¸âƒ£ Unzip the build
      - name: Unzip angular-build.zip
        run: |
          echo "ğŸ“¦ Unzipping angular-build.zip..."
          mkdir -p ./unzipped_build
          unzip -o angular-build.zip -d ./unzipped_build
          echo "âœ… Unzip complete. Contents:"
          ls -lR ./unzipped_build

      # ğŸš€ 3ï¸âƒ£ Deploy build to Nginx directory
      - name: Deploy to /var/www/html
        run: |
          echo "ğŸš€ Deploying Angular build to Nginx..."

          sudo rm -rf /var/www/html/*
          sudo cp -r ./unzipped_build/* /var/www/html/

          # If build contains subfolder (e.g., TestEnv), move contents up
          if [ -d "/var/www/html/TestEnv" ]; then
            echo "ğŸ“ Detected TestEnv folder, moving contents..."
            sudo mv /var/www/html/TestEnv/* /var/www/html/
            sudo rm -rf /var/www/html/TestEnv
          fi

          echo "âœ… Deployment completed. Listing /var/www/html:"
          sudo ls -l /var/www/html

      # ğŸ§© 4ï¸âƒ£ Verify deployment
      - name: Verify deployment
        run: |
          if [ -f /var/www/html/index.html ]; then
            echo "âœ… index.html found. Angular app deployed successfully!"
          else
            echo "âŒ index.html missing. Deployment failed."
            echo "ğŸ“‚ Directory contents:"
            sudo ls -l /var/www/html
            exit 1
          fi

      # ğŸ”„ 5ï¸âƒ£ Reload Nginx
      - name: Reload Nginx
        run: |
          echo "ğŸ”„ Testing and reloading Nginx..."
          sudo nginx -t
          sudo systemctl reload nginx
          echo "âœ… Nginx reloaded successfully."
